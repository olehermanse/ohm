<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ohm</title>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Varela+Round" rel="stylesheet" />
    <style type="text/css">
      * {
        margin: 0;
        padding: 0;
        font-family: "Varela Round", Helvetica, Arial, Sans-Serif;
      }

      .sidebar {
        height: 100vh;
        min-height: 600px;
        width: 90px;
        background-color: #ececec;
        color: #4a4a4a;
        display: flex;
        flex-direction: column;
      }

      .sidebar_content {
        height: 100%;
        display: flex;
        flex-direction: column;
      }

      .toolheader {
        flex: 0 1 auto;
        margin: auto;
        margin-top: 1em;
      }

      .toolbox {
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;
        margin: auto;
        margin-top: 1em;
        margin-bottom: 1em;
      }

      .tool {
        flex: 1 1 auto;
        width: 36;
        height: 36;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .active_tool {
        color: blue;
      }

      .tool_svg {
        width: 28;
        height: 28;
      }

      .tool_svg:hover {
        width: 36;
        height: 36;
        cursor: pointer;
      }

      .delete {
        fill: red;
        stroke: red;
      }

      body {
        background-color: #f2f2f2;
        display: flex;
        min-height: 100vh;
      }

      h1 {
        font-size: 1.5em;
      }

      #drawing {
        background-color: #ffffff;
        border: 2px;
        border-color: #4a4a4a;
        margin: 1em;
      }
    </style>
    <script>
      var ohm_state = "circle";
      var tmp_wire = null;

      function init_ohm() {
        var p = document.getElementById("drawing");
        p.onmousedown = draw_mouse_down;
        p.onmousemove = draw_mouse_move;
        init_grid();
        set_state(ohm_state);
      }

      function create_grid_line(x1, y1, x2, y2) {
        var drawing = document.getElementById("drawing");
        var line = document.createElementNS("http://www.w3.org/2000/svg", "line");
        line.setAttribute("x1", "" + x1);
        line.setAttribute("y1", "" + y1);
        line.setAttribute("x2", "" + x2);
        line.setAttribute("y2", "" + y2);
        line.setAttribute("id", "grid_line");
        line.setAttribute("style", "stroke:rgb(200,200,200);stroke-width:0.4");
        drawing.appendChild(line);
      }

      function init_grid() {
        var drawing = document.getElementById("drawing");
        var svg_width = Number(drawing.getAttribute("width"));
        var svg_height = Number(drawing.getAttribute("height"));
        for (var x = 50; x <= svg_width; x += 50) {
          create_grid_line(x, 0, x, svg_width);
        }
        for (var y = 50; y <= svg_height; y += 50) {
          create_grid_line(0, y, svg_height, y);
        }
      }

      function set_state(new_state) {
        ohm_state = new_state;
        var toolbox = document.getElementById("toolbox");
        for (let tool of toolbox.children) {
          if (tool.id === ohm_state) {
            tool.classList.add("active_tool");
          } else {
            tool.classList.remove("active_tool");
          }
        }
      }

      function round_to_grid(pos) {
        return Math.round(pos / 50) * 50;
      }

      // From: https://gist.github.com/liabru/11263260#gistcomment-2894088
      function download(filename, text) {
        var element = document.createElement("a");
        element.setAttribute("href", "data:text/plain;charset=utf-8," + encodeURIComponent(text));
        element.setAttribute("download", filename);

        element.style.display = "none";
        document.body.appendChild(element);

        element.click();

        document.body.removeChild(element);
      }

      function remove_grid_lines(drawing) {
        while (drawing.getElementById("grid_line")) {
          drawing.removeChild(drawing.getElementById("grid_line"));
        }
      }

      function save_tool() {
        var copy = document.getElementById("drawing").cloneNode(true);
        remove_grid_lines(copy)
        var svg_text = copy.outerHTML;
        download("schematic.svg", svg_text);
      }

      function load_tool() {
        alert("Load is not implemented (yet)!");
      }

      function share_tool() {
        alert("Share is not implemented (yet)!");
      }

      function wire_tool() {
        set_state("wire");
      }

      function circle_tool() {
        set_state("circle");
      }

      function component_tool() {
        set_state("component");
      }

      function text_tool() {
        set_state("text");
      }

      function rectangle_tool() {
        set_state("rectangle");
      }

      function delete_tool() {
        set_state("delete");
      }

      function copy_tool() {
        set_state("copy");
      }

      function find_circle(x, y) {
        var drawing = document.getElementById("drawing");

        for (let element of drawing.children) {
          if (element.tagName === "circle" && element.getAttribute("cx") === x && element.getAttribute("cy") === y && element.getAttribute("r") === "10") {
            return element;
          }
        }
        return null;
      }

      function circle_exists(x, y) {
        return find_circle(x, y) != null;
      }

      function place_circle(x, y) {
        if (circle_exists(x, y)) {
          return;
        }
        var drawing = document.getElementById("drawing");
        var circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        circle.setAttribute("cx", x);
        circle.setAttribute("cy", y);
        circle.setAttribute("r", "10");
        circle.setAttribute("fill", "black");
        drawing.appendChild(circle);
      }

      function place_wire(wire, id) {
        start_x = "" + round_to_grid(wire.start_x);
        start_y = "" + round_to_grid(wire.start_y);
        end_x = "" + round_to_grid(wire.end_x);
        end_y = "" + round_to_grid(wire.end_y);

        var drawing = document.getElementById("drawing");
        var line = document.createElementNS("http://www.w3.org/2000/svg", "line");
        line.setAttribute("x1", start_x);
        line.setAttribute("y1", start_y);
        line.setAttribute("x2", end_x);
        line.setAttribute("y2", end_y);
        line.setAttribute("id", id);
        line.setAttribute("stroke", "black");
        if (id === "tmp_wire") {
          line.setAttribute("stroke", "blue");
        }
        line.setAttribute("stroke-width", "10");
        drawing.appendChild(line);
      }

      function update_wire_svg() {
        if (tmp_wire === null) {
          // Nothing to update
        } else {
          let element = document.getElementById("tmp_wire");
          if (!element) {
            return;
          }
          element.setAttribute("x2", tmp_wire.end_x);
          element.setAttribute("y2", tmp_wire.end_y);
        }
      }

      function wire_start(x, y) {
        tmp_wire = {
          start_x: x,
          start_y: y,
          end_x: x,
          end_y: y
        };

        place_wire(tmp_wire, "tmp_wire");
        update_wire_svg();
      }

      function wire_move(x, y) {
        if (tmp_wire === null) {
          return;
        }
        tmp_wire.end_x = x;
        tmp_wire.end_y = y;
        update_wire_svg();
      }

      function elements_to_delete(x, y) {
        var will_be_deleted = [];
        var circle = find_circle(x, y);
        var drawing = document.getElementById("drawing");

        if (circle) {
          will_be_deleted.push(circle);
        }
        return will_be_deleted;
      }

      function delete_click(x, y) {
        var elements = elements_to_delete(x, y);

        for (let element of elements) {
          element.remove();
        }
      }

      function delete_move(x, y) {
        var to_delete = elements_to_delete(x, y);
        var drawing = document.getElementById("drawing");

        for (let element of drawing.children) {
          if (to_delete.includes(element)) {
            element.classList.add("delete");
          } else {
            element.classList.remove("delete");
          }
        }
      }

      function wire_end() {
        let element = document.getElementById("tmp_wire");
        element.setAttribute("id", "wire");
        element.setAttribute("stroke", "black");
        tmp_wire = null;
        update_wire_svg();
      }

      function wire_click(x, y) {
        if (tmp_wire === null) {
          wire_start(x, y);
        } else {
          wire_end();
        }
      }

      function draw_mouse_down(event) {
        x = "" + round_to_grid(event.offsetX);
        y = "" + round_to_grid(event.offsetY);
        if (ohm_state === "circle") {
          place_circle(x, y);
        } else if (ohm_state === "wire") {
          wire_click(x, y);
        } else if (ohm_state === "delete") {
          delete_click(x, y);
        }
      }

      function draw_mouse_move(event) {
        x = "" + round_to_grid(event.offsetX);
        y = "" + round_to_grid(event.offsetY);
        if (ohm_state === "wire") {
          wire_move(x, y);
        } else if (ohm_state === "delete") {
          delete_move(x, y);
        }
      }
    </script>
  </head>
  <body onload="init_ohm();">
    <div class="sidebar">
      <div class="sidebar_content">
        <h1 class="toolheader">ohm</h1>
        <div id="toolbox" class="toolbox">
          <div title="Add wire" class="tool" id="wire" onclick="wire_tool();"><svg class="tool_svg" data-feather="edit-2"></svg></div>
          <div title="Add dot" class="tool" id="circle" onclick="circle_tool();"><svg class="tool_svg" data-feather="circle"></svg></div>
          <div title="Add component" class="tool" id="component" onclick="component_tool();"><svg class="tool_svg" data-feather="cpu"></svg></div>
          <div title="Add text" class="tool" id="text" onclick="text_tool();"><svg class="tool_svg" data-feather="type"></svg></div>
          <div title="Add rectangle" class="tool" id="rectangle" onclick="rectangle_tool();"><svg class="tool_svg" data-feather="square"></svg></div>
          <div title="Copy" class="tool" id="copy" onclick="copy_tool();"><svg class="tool_svg" data-feather="copy"></svg></div>
          <div title="Delete object" class="tool" id="delete" onclick="delete_tool();"><svg class="tool_svg" data-feather="x"></svg></div>
          <div title="Save" class="tool" id="save" onclick="save_tool();"><svg class="tool_svg" data-feather="save"></svg></div>
          <div title="Load" class="tool" id="load" onclick="load_tool();"><svg class="tool_svg" data-feather="upload"></svg></div>
          <div title="Share" class="tool" id="share" onclick="share_tool();"><svg class="tool_svg" data-feather="external-link"></svg></div>
        </div>
      </div>
    </div>
    <svg id="drawing" width="600" height="600" version="1.1" xmlns="http://www.w3.org/2000/svg"></svg>
  </body>
  <script>
    feather.replace();
  </script>
</html>
